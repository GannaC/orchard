<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>U.S. States: Population and Territory</title>
    <style>
      :root {
        --bg-1: #f7f3e9;
        --bg-2: #dce9f6;
        --ink: #1f2933;
        --muted: #52606d;
        --panel: #ffffffd9;
        --accent: #0d6e6e;
        --accent-soft: #7fc9c7;
        --border: #d9e2ec;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Avenir Next", "Segoe UI", "Trebuchet MS", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 12% 8%, #fff6d1 0%, transparent 40%),
          radial-gradient(circle at 88% 16%, #d4efe5 0%, transparent 35%),
          linear-gradient(145deg, var(--bg-1), var(--bg-2));
      }

      .wrap {
        width: min(1200px, 96vw);
        margin: 2rem auto 3rem;
      }

      .hero {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 1.2rem 1.4rem;
        box-shadow: 0 14px 35px -28px #1f293366;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.3rem, 1.1rem + 1.7vw, 2.25rem);
        line-height: 1.15;
        letter-spacing: 0.01em;
      }

      .subtitle {
        margin: 0.55rem 0 0;
        color: var(--muted);
        max-width: 75ch;
      }

      .grid {
        margin-top: 1rem;
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 10px 28px -24px #1f293355;
      }

      .controls {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .controls label {
        font-weight: 600;
      }

      .controls select,
      .controls button {
        border: 1px solid #bcccdc;
        border-radius: 10px;
        background: #fff;
        padding: 0.45rem 0.68rem;
        font: inherit;
        color: inherit;
      }

      .controls button {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        cursor: pointer;
      }

      .bars {
        margin-top: 1rem;
        display: grid;
        gap: 0.45rem;
        max-height: 68vh;
        overflow: auto;
        padding-right: 0.35rem;
      }

      .row {
        display: grid;
        grid-template-columns: minmax(120px, 180px) 1fr max-content;
        align-items: center;
        gap: 0.6rem;
      }

      .state {
        font-weight: 600;
        font-size: 0.92rem;
      }

      .track {
        height: 1.35rem;
        border-radius: 999px;
        background: #e7eef4;
        overflow: hidden;
      }

      .fill {
        height: 100%;
        width: var(--w, 0%);
        background: linear-gradient(90deg, var(--accent), var(--accent-soft));
        border-radius: inherit;
        transition: width 560ms cubic-bezier(0.2, 0.8, 0.22, 1);
      }

      .value {
        min-width: 84px;
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-size: 0.9rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        position: sticky;
        top: 0;
        background: #fff;
      }

      th,
      td {
        text-align: left;
        padding: 0.46rem 0.32rem;
        border-bottom: 1px solid #e4ebf3;
        font-size: 0.9rem;
      }

      .table-wrap {
        max-height: 52vh;
        overflow: auto;
      }

      .meta {
        margin-top: 0.8rem;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .status {
        margin-top: 0.85rem;
        font-size: 0.9rem;
      }

      .status.error {
        color: #b42318;
      }

      a {
        color: #0a5ea8;
      }

      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 1.2fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="hero">
        <h1>All 50 U.S. States: Population and Territory</h1>
        <p class="subtitle">
          Interactive comparison using official U.S. Census Bureau data. Choose a metric to compare
          states by population, land area, total area, or population density.
        </p>
      </section>

      <section class="grid" aria-live="polite">
        <article class="panel">
          <div class="controls">
            <label for="metric">Metric</label>
            <select id="metric">
              <option value="population">Population</option>
              <option value="landArea">Land area (sq mi)</option>
              <option value="totalArea">Total area (sq mi)</option>
              <option value="density">Population density (people/sq mi)</option>
            </select>

            <label for="sort">Sort</label>
            <select id="sort">
              <option value="desc">Highest to lowest</option>
              <option value="asc">Lowest to highest</option>
            </select>

            <button id="animate" type="button">Replay animation</button>
          </div>

          <div class="bars" id="bars" role="img" aria-label="State comparison chart"></div>
          <div class="status" id="status">Loading Census data...</div>
          <p class="meta" id="sources"></p>
        </article>

        <article class="panel">
          <h2 style="margin: 0 0 0.7rem; font-size: 1.1rem">State data table</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>State</th>
                  <th>Population</th>
                  <th>Land sq mi</th>
                  <th>Total sq mi</th>
                  <th>Density</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </article>
      </section>
    </main>

    <script>
      const STATES_50_FIPS = new Set([
        "01", "02", "04", "05", "06", "08", "09", "10", "12", "13",
        "15", "16", "17", "18", "19", "20", "21", "22", "23", "24",
        "25", "26", "27", "28", "29", "30", "31", "32", "33", "34",
        "35", "36", "37", "38", "39", "40", "41", "42", "44", "45",
        "46", "47", "48", "49", "50", "51", "53", "54", "55", "56"
      ]);

      const state = {
        rows: [],
        metric: "population",
        sort: "desc",
        sourcePop: "",
        sourceArea: ""
      };

      const metricSelect = document.getElementById("metric");
      const sortSelect = document.getElementById("sort");
      const barsEl = document.getElementById("bars");
      const tableBody = document.getElementById("tableBody");
      const statusEl = document.getElementById("status");
      const sourcesEl = document.getElementById("sources");
      const animateBtn = document.getElementById("animate");

      metricSelect.addEventListener("change", () => {
        state.metric = metricSelect.value;
        render();
      });

      sortSelect.addEventListener("change", () => {
        state.sort = sortSelect.value;
        render();
      });

      animateBtn.addEventListener("click", () => {
        barsEl.querySelectorAll(".fill").forEach((el) => {
          const target = el.style.getPropertyValue("--w") || "0%";
          el.style.setProperty("--w", "0%");
          requestAnimationFrame(() => el.style.setProperty("--w", target));
        });
      });

      function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(num);
      }

      function getMetricValue(row) {
        if (state.metric === "landArea") return row.landArea;
        if (state.metric === "totalArea") return row.totalArea;
        if (state.metric === "density") return row.density;
        return row.population;
      }

      function metricLabel(row) {
        if (state.metric === "population") return formatNumber(row.population);
        if (state.metric === "landArea") return formatNumber(row.landArea, 1);
        if (state.metric === "totalArea") return formatNumber(row.totalArea, 1);
        return formatNumber(row.density, 1);
      }

      function sortedRows() {
        const copy = [...state.rows];
        copy.sort((a, b) => {
          const diff = getMetricValue(a) - getMetricValue(b);
          return state.sort === "asc" ? diff : -diff;
        });
        return copy;
      }

      function render() {
        if (!state.rows.length) return;
        const rows = sortedRows();
        const max = Math.max(...rows.map(getMetricValue));

        barsEl.innerHTML = rows
          .map((row) => {
            const width = max ? (getMetricValue(row) / max) * 100 : 0;
            return `
              <div class="row">
                <div class="state">${row.name}</div>
                <div class="track"><div class="fill" style="--w:${width.toFixed(2)}%"></div></div>
                <div class="value">${metricLabel(row)}</div>
              </div>
            `;
          })
          .join("");

        tableBody.innerHTML = rows
          .map(
            (row) => `
            <tr>
              <td>${row.name}</td>
              <td>${formatNumber(row.population)}</td>
              <td>${formatNumber(row.landArea, 1)}</td>
              <td>${formatNumber(row.totalArea, 1)}</td>
              <td>${formatNumber(row.density, 1)}</td>
            </tr>
          `
          )
          .join("");
      }

      async function fetchFirst(urls, parser) {
        let lastErr;
        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await parser(res);
            return { url, data };
          } catch (err) {
            lastErr = err;
          }
        }
        throw lastErr || new Error("All endpoints failed");
      }

      async function loadPopulation() {
        const candidates = [2024, 2023, 2022].map(
          (y) => `https://api.census.gov/data/${y}/pep/population?get=NAME,POP&for=state:*`
        );
        const { url, data } = await fetchFirst(candidates, (res) => res.json());
        const [headers, ...rows] = data;
        const idxName = headers.indexOf("NAME");
        const idxPop = headers.indexOf("POP");
        const idxState = headers.indexOf("state");

        const map = new Map();
        for (const row of rows) {
          const fips = row[idxState];
          if (!STATES_50_FIPS.has(fips)) continue;
          map.set(fips, {
            fips,
            name: row[idxName],
            population: Number(row[idxPop])
          });
        }
        return { url, map };
      }

      function parseTsv(text) {
        const lines = text.trim().split(/\r?\n/);
        const headers = lines[0].split("\t");
        const idx = Object.fromEntries(headers.map((h, i) => [h, i]));
        return lines.slice(1).map((line) => {
          const cols = line.split("\t");
          return {
            geoid: cols[idx.GEOID],
            name: cols[idx.NAME],
            landArea: Number(cols[idx.ALAND_SQMI]),
            waterArea: Number(cols[idx.AWATER_SQMI])
          };
        });
      }

      async function loadArea() {
        const candidates = [2024, 2023, 2022].map(
          (y) => `https://www2.census.gov/geo/docs/maps-data/data/gazetteer/${y}_Gaz_state_national.txt`
        );
        const { url, data } = await fetchFirst(candidates, (res) => res.text().then(parseTsv));

        const map = new Map();
        for (const row of data) {
          if (!STATES_50_FIPS.has(row.geoid)) continue;
          map.set(row.geoid, {
            fips: row.geoid,
            name: row.name,
            landArea: row.landArea,
            totalArea: row.landArea + row.waterArea
          });
        }
        return { url, map };
      }

      async function init() {
        try {
          const [pop, area] = await Promise.all([loadPopulation(), loadArea()]);
          const merged = [];

          for (const [fips, p] of pop.map.entries()) {
            const a = area.map.get(fips);
            if (!a || !Number.isFinite(a.landArea) || a.landArea <= 0) continue;
            merged.push({
              fips,
              name: p.name,
              population: p.population,
              landArea: a.landArea,
              totalArea: a.totalArea,
              density: p.population / a.landArea
            });
          }

          state.rows = merged;
          state.sourcePop = pop.url;
          state.sourceArea = area.url;

          statusEl.textContent = `Loaded ${merged.length} states from U.S. Census Bureau datasets.`;
          statusEl.classList.remove("error");
          sourcesEl.innerHTML = `Sources: <a href="${state.sourcePop}" target="_blank" rel="noreferrer">Census Population API</a> and <a href="${state.sourceArea}" target="_blank" rel="noreferrer">Census Gazetteer Files</a>.`;
          render();
        } catch (err) {
          statusEl.textContent = `Could not load Census data in this browser session. ${err.message}`;
          statusEl.classList.add("error");
          sourcesEl.innerHTML = "Official sources intended: U.S. Census Bureau Population Estimates Program API and Census Gazetteer state areas.";
          console.error(err);
        }
      }

      init();
    </script>
  </body>
</html>
