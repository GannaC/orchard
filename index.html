<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>U.S. States: Population and Territory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #f4f7fb;
        --bg-2: #eef3f9;
        --ink: #16213f;
        --muted: #5b6882;
        --panel: #ffffff;
        --accent: #1f5ebd;
        --accent-soft: #78a6ef;
        --border: #dfe7f2;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Source Sans 3", "Segoe UI", "Avenir Next", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 8% 8%, #ffffff 0%, transparent 32%),
          radial-gradient(circle at 92% 12%, #e8f0ff 0%, transparent 35%),
          linear-gradient(145deg, var(--bg-1), var(--bg-2));
      }

      .wrap {
        width: min(1200px, 96vw);
        margin: 2rem auto 3rem;
      }

      .hero {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 1.2rem 1.4rem;
        box-shadow: 0 10px 24px -20px #15264d40;
        border-top: 6px solid #f4a531;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.3rem, 1.1rem + 1.7vw, 2.25rem);
        line-height: 1.15;
        letter-spacing: 0.01em;
        color: #0f2247;
      }

      .subtitle {
        margin: 0.55rem 0 0;
        color: var(--muted);
        max-width: 75ch;
      }

      .grid {
        margin-top: 1rem;
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 10px 24px -20px #15264d33;
      }

      .controls {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .controls label {
        font-weight: 600;
        color: #233354;
      }

      .controls select {
        border: 1px solid #bcccdc;
        border-radius: 10px;
        background: #fff;
        padding: 0.45rem 0.68rem;
        font: inherit;
        color: inherit;
      }

      .bars {
        margin-top: 1rem;
        display: grid;
        gap: 0.45rem;
        max-height: 68vh;
        overflow: auto;
        padding-right: 0.35rem;
      }

      .row {
        display: grid;
        grid-template-columns: minmax(120px, 180px) 1fr max-content;
        align-items: center;
        gap: 0.6rem;
        opacity: 0;
        transform: translateY(8px);
        animation: row-in 420ms cubic-bezier(0.21, 0.95, 0.29, 1) forwards;
        animation-delay: var(--delay, 0ms);
      }

      .state {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.92rem;
      }

      .state-flag {
        width: 1.08rem;
        height: 1.08rem;
        border-radius: 999px;
        border: 1px solid #d9e3f2;
        background: #f6f8fc;
        object-fit: cover;
        flex: 0 0 auto;
      }

      .track {
        height: 1.35rem;
        border-radius: 999px;
        background: #eaf0f8;
        overflow: hidden;
      }

      .fill {
        height: 100%;
        width: var(--w, 0%);
        background: linear-gradient(90deg, var(--accent), #3d7cdd 58%, var(--accent-soft));
        border-radius: inherit;
        transition: width 760ms cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
      }

      .fill::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          105deg,
          transparent 0%,
          #ffffff66 45%,
          transparent 100%
        );
        transform: translateX(-120%);
        animation: shine 1.6s ease-out both;
      }

      .value {
        min-width: 84px;
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-size: 0.9rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        position: sticky;
        top: 0;
        background: #fff;
      }

      th,
      td {
        text-align: left;
        padding: 0.46rem 0.32rem;
        border-bottom: 1px solid #e4ebf3;
        font-size: 0.9rem;
      }

      th {
        color: #2a3f66;
      }

      .table-wrap {
        max-height: 52vh;
        overflow: auto;
      }

      .meta {
        margin-top: 0.8rem;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .status {
        margin-top: 0.85rem;
        font-size: 0.9rem;
      }

      .status.error {
        color: #b42318;
      }

      a {
        color: #1b59b7;
      }

      @keyframes row-in {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes shine {
        to {
          transform: translateX(120%);
        }
      }

      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 1.2fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="hero">
        <h1>All 50 U.S. States: Population and Territory</h1>
        <p class="subtitle">
          Interactive comparison using official U.S. Census Bureau TIGERweb data (2020 Census population
          and state area fields). Choose a metric to compare states by population, land area, total area,
          or population density.
        </p>
      </section>

      <section class="grid" aria-live="polite">
        <article class="panel">
          <div class="controls">
            <label for="metric">Metric</label>
            <select id="metric">
              <option value="population">Population</option>
              <option value="landArea">Land area (sq mi)</option>
              <option value="totalArea">Total area (sq mi)</option>
              <option value="density">Population density (people/sq mi)</option>
            </select>

            <label for="sort">Sort</label>
            <select id="sort">
              <option value="desc">Highest to lowest</option>
              <option value="asc">Lowest to highest</option>
            </select>

          </div>

          <div class="bars" id="bars" role="img" aria-label="State comparison chart"></div>
          <div class="status" id="status">Loading Census data...</div>
          <p class="meta" id="sources"></p>
        </article>

        <article class="panel">
          <h2 style="margin: 0 0 0.7rem; font-size: 1.1rem">State data table</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>State</th>
                  <th>Population</th>
                  <th>Land sq mi</th>
                  <th>Total sq mi</th>
                  <th>Density</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </article>
      </section>
    </main>

    <script>
      const STATES_50_FIPS = new Set([
        "01", "02", "04", "05", "06", "08", "09", "10", "12", "13",
        "15", "16", "17", "18", "19", "20", "21", "22", "23", "24",
        "25", "26", "27", "28", "29", "30", "31", "32", "33", "34",
        "35", "36", "37", "38", "39", "40", "41", "42", "44", "45",
        "46", "47", "48", "49", "50", "51", "53", "54", "55", "56"
      ]);

      const FIPS_TO_ABBR = {
        "01": "AL", "02": "AK", "04": "AZ", "05": "AR", "06": "CA", "08": "CO", "09": "CT", "10": "DE", "12": "FL", "13": "GA",
        "15": "HI", "16": "ID", "17": "IL", "18": "IN", "19": "IA", "20": "KS", "21": "KY", "22": "LA", "23": "ME", "24": "MD",
        "25": "MA", "26": "MI", "27": "MN", "28": "MS", "29": "MO", "30": "MT", "31": "NE", "32": "NV", "33": "NH", "34": "NJ",
        "35": "NM", "36": "NY", "37": "NC", "38": "ND", "39": "OH", "40": "OK", "41": "OR", "42": "PA", "44": "RI", "45": "SC",
        "46": "SD", "47": "TN", "48": "TX", "49": "UT", "50": "VT", "51": "VA", "53": "WA", "54": "WV", "55": "WI", "56": "WY"
      };

      const state = {
        rows: [],
        metric: "population",
        sort: "desc",
        sourcePop: "",
        sourceArea: ""
      };

      const metricSelect = document.getElementById("metric");
      const sortSelect = document.getElementById("sort");
      const barsEl = document.getElementById("bars");
      const tableBody = document.getElementById("tableBody");
      const statusEl = document.getElementById("status");
      const sourcesEl = document.getElementById("sources");

      metricSelect.addEventListener("change", () => {
        state.metric = metricSelect.value;
        render();
      });

      sortSelect.addEventListener("change", () => {
        state.sort = sortSelect.value;
        render();
      });

      function formatNumber(num, decimals = 0) {
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(num);
      }

      function stateFlagUrl(abbr) {
        return `https://hatscripts.github.io/circle-flags/flags/us-${abbr.toLowerCase()}.svg`;
      }

      function getMetricValue(row) {
        if (state.metric === "landArea") return row.landArea;
        if (state.metric === "totalArea") return row.totalArea;
        if (state.metric === "density") return row.density;
        return row.population;
      }

      function metricLabel(row) {
        if (state.metric === "population") return formatNumber(row.population);
        if (state.metric === "landArea") return formatNumber(row.landArea, 1);
        if (state.metric === "totalArea") return formatNumber(row.totalArea, 1);
        return formatNumber(row.density, 1);
      }

      function sortedRows() {
        const copy = [...state.rows];
        copy.sort((a, b) => {
          const diff = getMetricValue(a) - getMetricValue(b);
          return state.sort === "asc" ? diff : -diff;
        });
        return copy;
      }

      function render() {
        if (!state.rows.length) return;
        const rows = sortedRows();
        const max = Math.max(...rows.map(getMetricValue));

        barsEl.innerHTML = rows
          .map((row, i) => {
            const width = max ? (getMetricValue(row) / max) * 100 : 0;
            const flagSrc = stateFlagUrl(row.abbr);
            return `
              <div class="row" style="--delay:${Math.min(i * 22, 440)}ms">
                <div class="state"><img class="state-flag" src="${flagSrc}" alt="${row.name} flag" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'" />${row.name}</div>
                <div class="track"><div class="fill" style="--w:0%" data-target="${width.toFixed(2)}%"></div></div>
                <div class="value">${metricLabel(row)}</div>
              </div>
            `;
          })
          .join("");

        requestAnimationFrame(() => {
          barsEl.querySelectorAll(".fill").forEach((el, i) => {
            const target = el.getAttribute("data-target") || "0%";
            setTimeout(() => el.style.setProperty("--w", target), Math.min(i * 14, 420));
          });
        });

        tableBody.innerHTML = rows
          .map(
            (row) => `
            <tr>
              <td>${row.name}</td>
              <td>${formatNumber(row.population)}</td>
              <td>${formatNumber(row.landArea, 1)}</td>
              <td>${formatNumber(row.totalArea, 1)}</td>
              <td>${formatNumber(row.density, 1)}</td>
            </tr>
          `
          )
          .join("");
      }

      async function fetchFirst(urls, parser) {
        let lastErr;
        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await parser(res);
            return { url, data };
          } catch (err) {
            lastErr = err;
          }
        }
        throw lastErr || new Error("All endpoints failed");
      }

      async function loadTigerStates() {
        const layerIds = [54, 62, 70];
        const urls = layerIds.map(
          (id) =>
            `https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/${id}/query` +
            `?where=1%3D1&outFields=GEOID,NAME,AREALAND,AREAWATER,POP100&returnGeometry=false&f=json`
        );

        const { url, data } = await fetchFirst(urls, (res) => res.json());
        const features = Array.isArray(data.features) ? data.features : [];
        const sqMetersPerSqMile = 2589988.110336;

        return {
          url,
          rows: features
            .map((f) => f.attributes || {})
            .filter((a) => STATES_50_FIPS.has(String(a.GEOID).padStart(2, "0")))
            .map((a) => {
              const landSqMi = Number(a.AREALAND) / sqMetersPerSqMile;
              const waterSqMi = Number(a.AREAWATER) / sqMetersPerSqMile;
              const pop = Number(a.POP100);
              return {
                fips: String(a.GEOID).padStart(2, "0"),
                name: a.NAME,
                abbr: FIPS_TO_ABBR[String(a.GEOID).padStart(2, "0")] || "",
                population: pop,
                landArea: landSqMi,
                totalArea: landSqMi + waterSqMi,
                density: pop / landSqMi
              };
            })
        };
      }

      async function init() {
        try {
          const tiger = await loadTigerStates();
          const filtered = tiger.rows.filter(
            (row) =>
              Number.isFinite(row.population) &&
              Number.isFinite(row.landArea) &&
              row.landArea > 0
          );

          state.rows = filtered;
          state.sourcePop = tiger.url;
          state.sourceArea = tiger.url;

          statusEl.textContent = `Loaded ${filtered.length} states from U.S. Census TIGERweb.`;
          statusEl.classList.remove("error");
          sourcesEl.innerHTML = `Source: <a href="${state.sourcePop}" target="_blank" rel="noreferrer">U.S. Census TIGERweb State_County layer query</a> (2020 Census POP100 with AREALAND/AREAWATER).`;
          render();
        } catch (err) {
          statusEl.textContent = `Could not load Census data in this browser session. ${err.message}`;
          statusEl.classList.add("error");
          sourcesEl.innerHTML = "Official source intended: U.S. Census Bureau TIGERweb State_County layer.";
          console.error(err);
        }
      }

      init();
    </script>
  </body>
</html>
